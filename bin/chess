#!/bin/sh
#
# wildefyr - 2016 (c) CC
# record a chess game in plain text

FILE="chess-$(date +'%d-%m-%Y %H:%M')"

prompt() {
    printf '%s' ": "
    continue
}

printf '%s' ": "; while read -r INPUT; do
    test -z "$INPUT" && {
        printf '%s\n' "Input cannot be empty!"
        prompt
    }

    INPUT=$(printf '%s\n' "$INPUT" | tr '[A-Z]' '[a-z]')

    PIECE=$(printf '%s\n' "$INPUT" | cut -d\  -f 1)

    case "$PIECE" in
        p|k|b|r|q|k) 
            PIECE=$(printf '%s\n' "$PIECE" | tr '[a-z]' '[A-Z]')
            ;;
        *) 
            printf '%s\n' "Not a valid piece!"
            prompt
            ;;
    esac

    POSITION=$(printf '%s\n' "$INPUT" | cut -d\  -f 2)

    test $(printf '%s' "$POSITION" | wc -c) -ne 2 && {
        printf '%s\n' "Not a valid position!"
        prompt
    }

    W=$(printf '%s' "$POSITION" | cut -c 1)
    H=$(printf '%s' "$POSITION" | cut -c 2)

    case "$W" in
        a|b|c|d|e|f|g|h)
            W=$(printf '%s\n' "$W" | tr '[a-z]' '[A-Z]')
            ;;
        *)
            printf '%s\n' "Not a valid position!"
            prompt
            ;;
    esac

    test "$H" -gt 8 && { 
        printf '%s\n' "Not a valid position!"
        prompt
    }

    EXTRA=$(printf '%s\n' "$INPUT" | cut -d\  -f 3)
    test ! -z "$EXTRA" && {
        printf '%s\n' "Input is too long!"
        prompt
    }

    test -f "$FILE" && {
        test $(($(wc -l < "$FILE") % 2)) -eq 0 && {
            printf '%s\n' "W ${PIECE} ${W}${H}" >> "$FILE"
        } || {
            printf '%s\n' "B ${PIECE} ${W}${H}" >> "$FILE"
        }
    } || {
        printf '%s\n' "W ${PIECE} ${W}${H}" >> "$FILE"
    }

    clear
    cat "$FILE"
    printf '\n'
    prompt
done
